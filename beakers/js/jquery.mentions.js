/*
 * jQuery @mentions plugin, v1.1
 *
 * Copyright 2011, Paul Gibbs <paul@byotos.com>.
 *
 * Licensed under GPL Version 2 and/or 3.
 * http://www.gnu.org/licenses/gpl-2.0.html
 * http://www.gnu.org/licenses/gpl-3.0.html
 *
 * Requires jQuery 1.6+
 */
(function(e){e.fn.mentions=function(t){t=e.extend({},e.fn.mentions.defaults,t);var n={up:38,down:40,enter:13,esc:27,at:64};return this.each(function(){function h(){var t='<ul id="mentions-autosuggest"></ul>';var n=r.parent();if(l.resultsbox){if("string"==typeof l.resultsbox){n=e(l.resultsbox);if("prepend"==l.resultsbox_position){e(l.resultsbox).prepend(t)}else if("append"==l.resultsbox_position){e(l.resultsbox).append(t)}else if("before"==l.resultsbox_position){e(l.resultsbox).before(t);n=n.parent()}else if("after"==l.resultsbox_position){e(l.resultsbox).after(t);n=n.parent()}}else if(l.resultsbox){n=l.resultsbox;if("prepend"==l.resultsbox_position){l.resultsbox.prepend(t)}else if("append"==l.resultsbox_position){l.resultsbox.append(t)}else if("before"==l.resultsbox_position){l.resultsbox.before(t);n=n.parent()}else if("after"==l.resultsbox_position){l.resultsbox.after(t);n=n.parent()}}}else{if("prepend"==l.resultsbox_position){n.prepend(t)}else if("append"==l.resultsbox_position){n.append(t)}else if("before"==l.resultsbox_position){n.before(t);n=n.parent()}else if("after"==l.resultsbox_position){n.after(t);n=n.parent()}}s=n.find("#mentions-autosuggest")}function p(){clearTimeout(f);window.setTimeout(function(){s.slideUp("slow",function(){console.log("empty");s.empty();r[0].setSelectionRange(r.val().length,r.val().length);r.focus()});i=o=false;u=""},50)}function d(){if(!i){clearTimeout(f);return}a=c.exec(r.val());if(!a){u=a="";return}if(u==a){return}if(e.isFunction(l.start)){l.start.call(this,a)}if("whats-new-options"==e(l.resultsbox).attr("id")&&"inherit"!=e(l.resultsbox).css("overflow")){e(l.resultsbox).css("overflow","inherit").css("position","relative").css("z-index","100")}if(!o){s.css("width",r.outerWidth(false)-4).html('<li class="section ajaxloader"><p><span class="ajax-loader" style="display: inline"></span>'+BPMentions.searching+"</p></li>").show()}else{s.css("width",r.outerWidth(false)-4).prepend('<li class="section ajaxloader"><p><span class="ajax-loader" style="display: inline"></span>'+BPMentions.searching+"</p></li>").show()}var t=s.data("bpl_"+a);if(t){v(t,"success",null,a)}else{e.ajax({dataType:l.dataType,type:"POST",url:ajaxurl,data:{action:"activity_mention_autosuggest",cookie:encodeURIComponent(document.cookie),format:l.dataType,limit:l.max_suggestions,search:a},error:l.error,success:function(e,t,n){v(e,t,n,a)}})}u=a}function v(t,n,i,u){if("success"==n){s.data("bpl_"+u,t)}if(e.isFunction(l.success)){l.success.call(t,n,i)}if("html"==l.dataType){s.find("li.ajaxloader").fadeOut("fast",function(){e(this).remove();if("-1"==t){if(e.isFunction(l.error)){l.error.call(t,n,i)}s.html('<li class="section error"><p><span>'+BPMentions.error1+"</span> "+BPMentions.error2+"</p></li>");return}else if("0"==t){s.html('<li class="section error"><p><span>'+BPMentions.noresults1+"</span> "+BPMentions.noresults2+"</p></li>")}else{s.css("width",r.outerWidth(false)-4);if(!o){s.slideUp("slow",function(){s.html(t).slideDown("slow")})}else{s.html(t)}}o=true});if(e.isFunction(l.complete)){l.complete.call(t,n,i)}}}function m(e){r.val(r.val().substring(0,r.val().lastIndexOf("@"))+"@"+e+" ");p()}var r=e(this),i=false,s=null,o=false,u="",a="",f=0,l=e.meta?e.extend({},t,r.data()):t,c=new RegExp("@[\\w\\\\\\.\\-]+\\s?(?:[\\w\\\\\\.\\-]+\\s?){0,"+(l.max_name_parts-1)+"}(?:[\\w\\\\\\.\\-]w+)?$");e(function(){h();r.bind("keypress.mentions",function(e){if(n.at==e.which&&!i){i=true}else if(i){clearTimeout(f);if(o){f=setTimeout(d,800)}else{f=setTimeout(d,350)}}});r.bind("keyup.mentions",function(e){if((n.esc==e.keyCode||n.enter==e.keyCode)&&o){e.preventDefault();p()}});r.bind("focusout.mentions",function(e){if(o){p()}});s.delegate("li:not(.section)","click.mentions",function(t){t.preventDefault();m(e(this).attr("class"))})})})};e.fn.mentions.defaults={resultsbox_position:"append",dataType:"html",max_name_parts:3,max_suggestions:6,resultsbox:"",start:null,success:null,complete:null,error:null}})(jQuery)